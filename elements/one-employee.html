<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/core-drag-drop/core-drag-drop.html">

<polymer-element draggable="false" name="one-employee" attributes="employee dragInfo">
    <template>
        <link rel="stylesheet" href="one-employee.css" type="text/css">
        <!-- to allow nested core-drag-drop elements, added a property object "ongoingDrag" to core-drag-drop element to prevent multiple listeners influencing the singe core-avatar, and change the object's value property to true/false on trackStart vs trackEnd event handlers and only run trackStart function if value is false -->
        <core-drag-drop></core-drag-drop>
        <template bind="{{employee}}">
            {{code}}
        </template>
    </template>
    <script>
        (function() {
            Polymer('one-employee', {
                ready: function() {
                    this.addEventListener('drag-start', this.oneEmployeeDragStart); //doesn't work declaratively since drag-start is caught and re-fired by core-drag-drop
                    this.addEventListener('down', function (event) {
                        this.target = event._target;
                    },this);
                },
                oneEmployeeDragStart: function(event) {
                    var self = this;
                    var dragInfo = event.detail; //has to be event.detail, detail does not work. (core-drag-drop functionality)
                    this.dragInfo = dragInfo; //binding to the rest of the application
                    dragInfo.subElement = this.target;
                    dragInfo.avatar.style.cssText = 'display: block; z-index: 1000; left: -14px; top: -8px; border: 1px solid gray' + '; font-size: 60%; width: 24px; height: 12px; border-radius: 25%; text-align: center;'; //should be done better
                    if (dragInfo.subElement.id === "oneEmployee") {
                        dragInfo.avatar.style.backgroundColor = this.employee.bgColor;
                        dragInfo.avatar.innerText = this.employee.code;
                        dragInfo.draggedType = "employee";
                    }

                    dragInfo.draggedItem = this;
                    dragInfo.dropTarget = null;
                    self.dragged = true;
                    dragInfo.drag = function (dragInfo) {
                        var draggedItem = dragInfo.draggedItem;
                        //added specialRelatedTarget = inEvent.currentTarget to var gestureProto = { ... } in polymer.js
                        //to make dropTarget available in drag (track) event.
                        var dropTarget = dragInfo.event.specialRelatedTarget;
                        var dropSubTarget = dragInfo.event.specialRelatedSubTarget; //temp test
                        if (dropTarget !== draggedItem) {
                            if (dropTarget.id === "oneShift") {
                                //self.addStyleToTargetOneShift(dropTarget);
                                dragInfo.dropTarget = dropTarget;
                            } else if (dropSubTarget.id === "oneWeek") {
                                //self.addStyleToTargetWeekDay(dropSubTarget);
                                //dropTarget = dragInfo.dropTarget;
                            } else {
                                dropTarget = dragInfo.dropTarget;
                                //self.resetStyleForTargetOneShift(dropTarget);
                            }
                        }
                        else {
                            dropTarget = dragInfo.dropTarget;
                            //self.resetStyleForTargetOneShift(dropTarget);
                        }
                    }; //seems to be needed to trigger some functionality in core-drag-drop
                    dragInfo.drop = function (dragInfo) {
                        //var dropTarget = dragInfo.event.relatedTarget;
                        var dropTarget = dragInfo.dropTarget;
                        if (dropTarget != null) {
                            dropTarget.style.backgroundColor = "red";
                        }
                        if (dragInfo.event.relatedTarget && dragInfo.event.relatedTarget.id === "oneShift") {
                            if (dragInfo.event.relatedTarget.classList) {
                                dragInfo.event.relatedTarget.classList.remove('dragEmployeeHover');
                            }
                        }
                        self.dragged = false;
                        self.dragInfo = {};
                        //self.resetStyleForTargetOneShift(dropTarget);
                    };
                },
                employeeColors: [],
                dragInfoChanged: function() {
                    this.style.cursor = Object.keys(this.dragInfo).length === 0 ? "default" : "none";
                }
            });
        })();
    </script>
</polymer-element>