<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="one-shift.html"/>

<polymer-element name="one-week" attributes="scheduleData weekNumber layout">
    <template>
        <link rel="stylesheet" href="one-week.css" type="text/css">
        <div id="weekSchedule" draggable="false">
            <template repeat="{{s in shifts}}">
                <one-shift id="oneShift" shiftData={{s}} />
            </template>
        </div>
        <div id="weekScheduleOverlay" draggable="false" style="pointer-events: none;"></div>
    </template>
    <script>

        var DAYS_IN_A_WEEK = 7;
        var MINUTES_IN_A_DAY = 1440;
        var MINUTES_IN_AN_HOUR = 60;
        var HOURS_IN_A_DAY = 24;
        var NUMBER_OF_VERTICAL_LINES = DAYS_IN_A_WEEK + 1;
        var VIEWBOX_MULTIPLIER = 5;

        Polymer('one-week', {
            shifts: [{
                dayOfWeek: 1,
                bgColor: '#ffcc66',
                color: 'black',
                workPlaceCode: "Tg.",
                employeeCode: "RR",
                shiftCode: "A2",
                startTime: 420,
                endTime: 1020,
                week: 2,
                repeatWeek: 2,
                numberOfShiftsWide: 2,
                shiftPosition: 1,
                pxWidth: 60
            },
            {
                dayOfWeek: 3,
                bgColor: '#ffcc66',
                color: 'black',
                workPlaceCode: "Tg.",
                employeeCode: "RR",
                shiftCode: "A1",
                startTime: 420,
                endTime: 960,
                week: 2,
                repeatWeek: 2,
                numberOfShiftsWide: 2,
                shiftPosition: 2,
                pxWidth: 60
            }],
            pxWidth: 420,
            pxHeight: 288,
            strokeWidth: 1,
            renderSchedule: function() {

                var strokeWidth = this.strokeWidth;
                var pxWidth = this.pxWidth + NUMBER_OF_VERTICAL_LINES; //why here and not for this.pxWidth?
                var pxHeight = this.pxHeight;
                var width = pxWidth * VIEWBOX_MULTIPLIER;
                var height = pxHeight * VIEWBOX_MULTIPLIER;
                var minuteHeight = height / MINUTES_IN_A_DAY;
                var dayWidth = (width - (VIEWBOX_MULTIPLIER * NUMBER_OF_VERTICAL_LINES))/ DAYS_IN_A_WEEK;
                var bgDraw = SVG(this.$.weekSchedule).fixSubPixelOffset().size(pxWidth,pxHeight).viewbox(-0.5, -0.5, width, height);
                bgDraw.rect(width,height).fill('#f0f0f0');

                var draw = SVG(this.$.weekScheduleOverlay).fixSubPixelOffset().size(pxWidth,pxHeight).viewbox(-0.5,-0.5,width,height).attr({ fill: 'none', 'stroke-width': strokeWidth, stroke: 'blue'});

                var path = '' +
                            //between days lines
                        'M ' + (dayWidth + VIEWBOX_MULTIPLIER) + ' 0'  + ' l 0 ' + (height) + ' ' +
                        'M ' + ((dayWidth + VIEWBOX_MULTIPLIER) * 2) + ' 0'  + ' l 0 ' + (height) + ' ' +
                        'M ' + ((dayWidth + VIEWBOX_MULTIPLIER) * 3) + ' 0'  + ' l 0 ' + (height) + ' ' +
                        'M ' + ((dayWidth + VIEWBOX_MULTIPLIER) * 4) + ' 0'  + ' l 0 ' + (height) + ' ' +
                        'M ' + ((dayWidth + VIEWBOX_MULTIPLIER) * 5) + ' 0'  + ' l 0 ' + (height) + ' ' +
                        'M ' + ((dayWidth + VIEWBOX_MULTIPLIER) * 6) + ' 0'  + ' l 0 ' + (height) + ' ' +
                            //border line
                        'M ' + 0 + ' ' + 0 + ' l ' + (width - VIEWBOX_MULTIPLIER) + ' 0 0 ' + (height) + ' -' + (width - VIEWBOX_MULTIPLIER) + ' 0 0 -' + (height) + 'Z ';
                //hour markers
                var hourMarkerWidth = dayWidth / 30;
                for (var hour = 1; hour < HOURS_IN_A_DAY; hour++) {
                    for (var day = 1; day <= DAYS_IN_A_WEEK; day++) {
                        path += 'M ' + ((day - 1) * (dayWidth + VIEWBOX_MULTIPLIER)) + ' ' + (hour * MINUTES_IN_AN_HOUR * minuteHeight) + ' l ' + hourMarkerWidth + ' 0 ';
                        path += 'M ' + (day * dayWidth + day * VIEWBOX_MULTIPLIER - hourMarkerWidth) + ' ' + (hour * MINUTES_IN_AN_HOUR * minuteHeight) + ' l ' + hourMarkerWidth + ' 0 ';
                    }
                }
                draw.path(path);
            },

            ready: function() {
                this.style.display = "block";
                this.style.position = "absolute";
                this.style.left = "100px";
                this.style.top = "100px";
                this.style.width = this.pxWidth + 'px';
                this.style.height = this.pxHeight + 'px';
                this.$.oneShift.addEventListener('started-dragging', function() {
                    alert("got here");
                });
                this.$.oneShift.addEventListener('stopped-dragging', function() {

                });
            },
            domReady: function() {
                this.$.weekScheduleOverlay.style.left = (this.weekNumber * 30) + "px";
                this.$.weekScheduleOverlay.style.top = (this.weekNumber * 30) + "px";
                this.$.weekSchedule.style.top = (this.weekNumber * 30) + "px";
                this.$.weekSchedule.style.left = (this.weekNumber * 30) + "px";

                //var oneShifts = this.shadowRoot.querySelectorAll('one-shift');

//                Array.prototype.forEach.call (oneShifts, function (os) {
//                    os.addEventListener('started-dragging', function() {
                //                       alert("got here");
                //  });
                //});

                this.renderSchedule();
                this.shifts.push({
                    dayOfWeek: 7,
                    bgColor: '#ffcc66',
                    color: 'black',
                    workPlaceCode: "Tg.",
                    employeeCode: "RR",
                    shiftCode: "A2",
                    startTime: 450,
                    endTime: 960,
                    week: 2,
                    repeatWeek: 2,
                    numberOfShiftsWide: 2,
                    shiftPosition: 2,
                    pxWidth: 60
                });
            }
        });
    </script>
</polymer-element>