<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-slider/paper-slider.html"/>
<link rel="import" href="one-week.html"/>
<link rel="import" href="one-shift.html"/>
<link rel="import" href="one-employee.html"/>
<link rel="import" href="../bower_components/paper-button/paper-button.html"/>

<polymer-element unresolved name="one-schedule" on-shiftdragstart="shiftDragStart" on-shiftdragend="shiftDragEnd" on-shiftdragstartinweek="shiftDragStart" on-shiftdragendinweek="shiftDragEnd">
    <template>
        <link rel="stylesheet" href="one-schedule.css" type="text/css">
        <div id="headerContainer">
            <div id="scheduleSelectContainer" class="selectContainer">
            </div>
            <div id="employeeSelectContainer" class="selectContainer">
                <template repeat="{{employee in currentSchedule.employees}}">
                    <one-employee id="oneEmployee" employee="{{employee}}" dragInfo="{{dragInfo}}" style="background-color: {{employee.bgColor}};"></one-employee>
                </template>
            </div>
            <div id="shiftSelectContainer" class="selectContainer">
            </div>
        </div>
        <div id="scheduleContainer">
            <paper-slider id="paperSlider" min="300" max="900" value="[[pxWeekWidth]]" immediateValue="{{pxWeekWidth}}"></paper-slider>
            <template repeat="{{weekSchedule, index in currentSchedule.weekSchedules}}">
                <one-week id="oneWeek" data="{{weekSchedule}}" pxWidth="{{pxWeekWidth}}" pxHeight="{{pxWeekWidth * 288 / 420 / 1.66}}" weekNumber="{{index + 1}}" layout="{{currentSchedule.weekSchedules.length}}" dragInfo="{{dragInfo}}"></one-week>
            </template>
        </div>
    </template>
    <script src="../bower_components/svg.js/dist/svg.js"></script>
    <script>
        Polymer('one-schedule', {
            pxWeekWidth: 420,
            currentSchedule: {
                name: "",
                weekSchedules: [],
                shiftDefinitions: [],
                employees: []
            },
            schedules: [
                {
                    name: "Schema 1",
                    numberOfWeeks: 4,
                    employeeCodes: ["AA", "BB", "CC", "DD", "EE", "FF", "GG", "HH", "II", "JJ", "KK", "LL", "MM", "NN", "OO", "PP"],
                    shiftDefinitions: [
                        {
                            code: "A1",
                            startTime: 420,
                            endTime: 960
                        },
                        {
                            code: "A2",
                            startTime: 420,
                            endTime: 930
                        },
                        {
                            code: "C1",
                            startTime: 930,
                            endTime: 1260
                        }
                    ],
                    shifts: [
                        {
                            employeeCode: "AA",
                            employeeCodes: ["AA"],
                            shiftCode: "A1",
                            workplaceCode: "WP1",
                            weeks: [1],
                            dayOfWeek: 3
                        },
                        {
                            employeeCode: "BB",
                            employeeCodes: ["AA", "BB"],
                            shiftCode: "C1",
                            workplaceCode: "WP2",
                            weeks: [1,2],
                            dayOfWeek: 4
                        }

                    ]
                },
                {
                    name: "Schema 2",
                    numberOfWeeks: 1,
                    employeeCodes: ["AA", "BB"],
                    shiftDefinitions: [
                        {
                            code: "A1",
                            startTime: 420,
                            endTime: 960
                        }
                    ]
                }
            ],
            weekSchedule: {},
            workplaces: [
                {
                    code: "WP1",
                    description: "workplace 1"
                },
                {
                    code: "WP2",
                    description: "workplace 2"
                }
            ],
            employees: [
                {
                    code: "AA",
                    name: "Agneta",
                    color: "black",
                    bgColor: "#ffbaba"
                },
                {
                    code: "BB",
                    name: "Bertil",
                    color: "black",
                    bgColor: "#fff3ba"
                },
                {
                    code: "CC",
                    name: "Cecilia",
                    color: "black",
                    bgColor: "#baffba"
                },
                {
                    code: "DD",
                    name: "Denise",
                    color: "black",
                    bgColor: "#d1c2ff"
                },
                {
                    code: "EE",
                    name: "Erik",
                    color: "black",
                    bgColor: "#ffe2ba"
                },
                {
                    code: "FF",
                    name: "Felicia",
                    color: "black",
                    bgColor: "#f3ffba"
                },
                {
                    code: "GG",
                    name: "Gustav",
                    color: "black",
                    bgColor: "#bde2fd"
                },
                {
                    code: "HH",
                    name: "Hanna",
                    color: "black",
                    bgColor: "#fdb9fd"
                },
                {
                    code: "II",
                    name: "Ivar",
                    color: "black",
                    bgColor: "#ffd4ba"
                },
                {
                    code: "JJ",
                    name: "Johan",
                    color: "black",
                    bgColor: "#fffcba"
                },
                {
                    code: "KK",
                    name: "Kristina",
                    color: "black",
                    bgColor: "#b9fdec"
                },
                {
                    code: "LL",
                    name: "Linda",
                    color: "black",
                    bgColor: "#dfbefe"
                },
                {
                    code: "MM",
                    name: "Maria",
                    color: "black",
                    bgColor: "#ffebba"
                },
                {
                    code: "NN",
                    name: "Niclas",
                    color: "black",
                    bgColor: "#e1ffba"
                },
                {
                    code: "OO",
                    name: "Oscar",
                    color: "black",
                    bgColor: "#c2cbfe"
                },
                {
                    code: "PP",
                    name: "Pernilla",
                    color: "black",
                    bgColor: "#febad7"
                }
            ],
            employeeFromCode: function(employeeCode) {
                var employees = this.employees.filter( function (employee) {
                    return employee.code === employeeCode;
                });
                return employees.length > 0 ? employees[0] : {};
            },
            employeesFromCodes: function(employeeCodes) {
                return this.employees.filter( function (employee) {
                    return employeeCodes.indexOf(employee.code) > -1;
                });
            },
            ready: function () {
                this.populateCurrentSchedule("Schema 1"); //pick first for now
            },
            populateCurrentSchedule: function(scheduleName) {
                var scheduleData = this.schedules.filter( function (schedule) {
                    return schedule.name === scheduleName;
                })[0];

                if (scheduleData === null) return;

                this.currentSchedule.shiftDefinitions = scheduleData.shiftDefinitions;

                this.currentSchedule.employees = this.employeesFromCodes(scheduleData.employeeCodes);

                this.currentSchedule.name = scheduleData.name;
                this.currentSchedule.weekSchedules = [];
                for (var i = 0; i < scheduleData.numberOfWeeks; i++) {
                    this.currentSchedule.weekSchedules.push({ shifts: [] });
                }

                scheduleData.shifts.forEach( function (shiftData) {
                    var shiftDefinition = scheduleData.shiftDefinitions.filter( function(shiftDefinition) {
                        return shiftDefinition.code === shiftData.shiftCode;
                    })[0];
                    for (var i = 0; i < shiftData.weeks.length; i++) {
                        var shift = {
                            code: shiftData.shiftCode,
                            employee: this.employees.filter( function(employee) {
                                return employee.code === shiftData.employeeCode;
                            })[0],
                            employees: this.employeesFromCodes(shiftData.employeeCodes),
                            workplace: this.workplaces.filter( function(workplace) {
                                return workplace.code === shiftData.workplaceCode;
                            })[0],
                            week: shiftData.weeks[i],
                            startTime: shiftDefinition ? shiftDefinition.startTime : 0,
                            endTime: shiftDefinition ? shiftDefinition.endTime : 0,
                            dayOfWeek: shiftData.dayOfWeek,
                            numberOfShiftsWide: 3,
                            shiftPosition: 2
                        };

                        //pxWidth: 60 //automatically calculated for now, might be needed?

                        //numberOfShiftsWide: 2,
                        //shiftPosition: 1,

                        this.currentSchedule.weekSchedules[i].shifts.push(shift);
                    }
                }, this);
                //add some more stuff to each shift.
            },
            shiftDragStart: function() {
                //this.style.cursor = "none";
                //this.$.paperSlider.style.cursor = "none";
            },
            shiftDragEnd: function() {
                //this.style.cursor = "default";
                //this.$.paperSlider.style.cursor = "default";
            },
            dragInfo: {},
            dragInfoChanged: function() {
                if (Object.keys(this.dragInfo).length === 0) { //check if this.dragInfo is an empty object (no object is dragged -> cursor should be visible)
                    this.style.cursor = "default";
                    this.$.paperSlider.style.cursor = "default";
                } else {
                    this.style.cursor = "none";
                    this.$.paperSlider.style.cursor = "none";
                }
            }
        });
    </script>
</polymer-element>