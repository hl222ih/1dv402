<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-slider/paper-slider.html"/>
<link rel="import" href="one-week.html"/>
<link rel="import" href="one-shift.html"/>
<link rel="import" href="one-employee.html"/>
<link rel="import" href="../bower_components/paper-button/paper-button.html"/>
<link rel="import" href="../bower_components/core-splitter/core-splitter.html"/>

<polymer-element unresolved name="one-schedule" horizontal layout>
    <template>
        <link rel="stylesheet" href="one-schedule.css" type="text/css">
        <div vertical layout style="width: 80%; height: 100%;">
            <div id="headerContainer" style="display: block; width: 98%; max-height: 10%;">
                <div id="scheduleSelectContainer" class="selectContainer">
                </div>
                <div id="employeeSelectContainer" class="selectContainer">
                    <template repeat="{{employee in currentSchedule.employees}}">
                        <one-employee id="oneEmployee" employee="{{employee}}" dragInfo="{{dragInfo}}" style="background-color: {{employee.bgColor}};"></one-employee>
                    </template>
                </div>
                <div id="shiftSelectContainer" class="selectContainer">
                    <!--some temp data-->
                    <div>A1: 07:00-16:00</div>
                    <div>A2: 07:00-15:00</div>
                    <div>B1: 09:00-16:00</div>
                    <div>B2: 09:00-15:00</div>
                    <div>C1: 16:00-21:15</div>
                    <div>C2: 16:30-21:30</div>
                    <div>R1: 12:00-16:00</div>
                </div>
            </div>
            <div flex id="scheduleContainer" style="margin: 1%; width: 98%;">
                <paper-slider id="paperSlider" min="200" max="900" value="[[pxWeekWidth]]" immediateValue="{{pxWeekWidth}}"></paper-slider>
                <template repeat="{{weekSchedule, index in currentSchedule.weekSchedules}}">
                    <one-week id="oneWeek" data="{{weekSchedule}}" pxWidth="{{pxWeekWidth}}" pxHeight="{{pxWeekWidth * 210 / 420 / 1}}" weekNumber="{{index + 1}}" layout="{{currentSchedule.weekSchedules.length}}" dragInfo="{{dragInfo}}"></one-week>
                </template>
            </div>
        </div>
        <core-splitter direction="left" allowOverflow="true"></core-splitter>
        <div flex id="infoContainer" style="font-family: 'Trebuchet MS', Helvetica, sans-serif;">
            right
        </div>
    </template>
    <script src="../bower_components/svg.js/dist/svg.js"></script>
    <script>
        var NUMBER_OF_MINUTES_IN_A_DAY = 1440;

        Polymer('one-schedule', {
            pxWeekWidth: 420,
            currentSchedule: {
                name: "",
                weekSchedules: [],
                shiftDefinitions: [],
                employees: []
            },
            schedules: [
                {
                    name: "Schema 1",
                    numberOfWeeks: 4,
                    employeeCodes: ["AA", "BB", "CC", "DD", "EE", "FF", "GG", "HH", "II", "JJ", "KK", "LL", "MM", "NN", "OO", "PP"],
                    shiftDefinitions: [
                        {
                            code: "A1", //07:00-16:00
                            startTime: 420,
                            endTime: 960
                        },
                        {
                            code: "A2",
                            startTime: 420,
                            endTime: 930
                        },
                        {
                            code: "C1", //10:30-21:15
                            startTime: 630,
                            endTime: 1275
                        },
                        {
                            code: "C2", //11-21
                            startTime: 660,
                            endTime: 1275
                        },
                        {
                            code: "N", //21:00-07:15
                            startTime: 1260,
                            endTime: 435
                        },
                        {
                            code: "Q1", //06:00-09:20
                            startTime: 360,
                            endTime: 560
                        }
                    ],
                    shifts: [
                        {
                            employeeCode: "AA",
                            employeeCodes: ["AA"],
                            shiftCode: "A1",
                            workplaceCode: "WP1",
                            weeks: [1],
                            dayOfWeek: 1
                        },
                        {
                            employeeCode: "BB",
                            employeeCodes: ["AA", "BB"],
                            shiftCode: "C1",
                            workplaceCode: "WP2",
                            weeks: [1,2],
                            dayOfWeek: 1
                        },
                        {
                            employeeCode: "AA",
                            employeeCodes: [],
                            shiftCode: "A1",
                            workplaceCode: "WP1",
                            weeks: [1],
                            dayOfWeek: 5
                        },
                        {
                            employeeCodes: ["DD"],
                            shiftCode: "N",
                            workPlaceCode: "WP1",
                            weeks: [2],
                            dayOfWeek: 4
                        },
                        {
                            employeeCodes: ["DD"],
                            shiftCode: "N",
                            workPlaceCode: "WP1",
                            weeks: [4],
                            dayOfWeek: 7
                        },
                        {
                            employeeCodes: ["PP"],
                            shiftCode: "Q1",
                            workPlaceCode: "WP1",
                            weeks: [1],
                            dayOfWeek: 1
                        },
                        {
                            employeeCodes: ["EE"],
                            shiftCode: "C2",
                            workPlaceCode: "WP1",
                            weeks: [1],
                            dayOfWeek: 1
                        },
                        {
                            employeeCodes: ["EE"],
                            shiftCode: "N",
                            workPlaceCode: "WP1",
                            weeks: [1],
                            dayOfWeek: 1
                        },
                        {
                            employeeCodes: ["EE"],
                            shiftCode: "N",
                            workPlaceCode: "WP1",
                            weeks: [1],
                            dayOfWeek: 1
                        },
                        {
                            employeeCodes: ["EE"],
                            shiftCode: "N",
                            workPlaceCode: "WP1",
                            weeks: [3],
                            dayOfWeek: 1
                        },
                        {
                            employeeCodes: ["EE"],
                            shiftCode: "A1",
                            workPlaceCode: "WP1",
                            weeks: [3],
                            dayOfWeek: 2
                        },
                        {
                            employeeCodes: ["EE"],
                            shiftCode: "C2",
                            workPlaceCode: "WP1",
                            weeks: [3],
                            dayOfWeek: 2
                        },
                        {
                            employeeCodes: ["EE"],
                            shiftCode: "N",
                            workPlaceCode: "WP1",
                            weeks: [3],
                            dayOfWeek: 2
                        },
                    ]
                },
                {
                    name: "Schema 2",
                    numberOfWeeks: 1,
                    employeeCodes: ["AA", "BB"],
                    shiftDefinitions: [
                        {
                            code: "A1",
                            startTime: 420,
                            endTime: 960
                        }
                    ]
                }
            ],
            weekSchedule: {},
            workplaces: [
                {
                    code: "WP1",
                    description: "workplace 1"
                },
                {
                    code: "WP2",
                    description: "workplace 2"
                }
            ],
            employees: [
                {
                    code: "AA",
                    name: "Agneta",
                    color: "black",
                    bgColor: "#ffbaba"
                },
                {
                    code: "BB",
                    name: "Bertil",
                    color: "black",
                    bgColor: "#fff3ba"
                },
                {
                    code: "CC",
                    name: "Cecilia",
                    color: "black",
                    bgColor: "#baffba"
                },
                {
                    code: "DD",
                    name: "Denise",
                    color: "black",
                    bgColor: "#d1c2ff"
                },
                {
                    code: "EE",
                    name: "Erik",
                    color: "black",
                    bgColor: "#ffe2ba"
                },
                {
                    code: "FF",
                    name: "Felicia",
                    color: "black",
                    bgColor: "#f3ffba"
                },
                {
                    code: "GG",
                    name: "Gustav",
                    color: "black",
                    bgColor: "#bde2fd"
                },
                {
                    code: "HH",
                    name: "Hanna",
                    color: "black",
                    bgColor: "#fdb9fd"
                },
                {
                    code: "II",
                    name: "Ivar",
                    color: "black",
                    bgColor: "#ffd4ba"
                },
                {
                    code: "JJ",
                    name: "Johan",
                    color: "black",
                    bgColor: "#fffcba"
                },
                {
                    code: "KK",
                    name: "Kristina",
                    color: "black",
                    bgColor: "#b9fdec"
                },
                {
                    code: "LL",
                    name: "Linda",
                    color: "black",
                    bgColor: "#dfbefe"
                },
                {
                    code: "MM",
                    name: "Maria",
                    color: "black",
                    bgColor: "#ffebba"
                },
                {
                    code: "NN",
                    name: "Niclas",
                    color: "black",
                    bgColor: "#e1ffba"
                },
                {
                    code: "OO",
                    name: "Oscar",
                    color: "black",
                    bgColor: "#c2cbfe"
                },
                {
                    code: "PP",
                    name: "Pernilla",
                    color: "black",
                    bgColor: "#febad7"
                }
            ],
            employeeFromCode: function(employeeCode) {
                var employees = this.employees.filter( function (employee) {
                    return employee.code === employeeCode;
                });
                return employees.length > 0 ? employees[0] : {};
            },
            employeesFromCodes: function(employeeCodes) {
                return this.employees.filter( function (employee) {
                    return employeeCodes.indexOf(employee.code) > -1;
                });
            },
            ready: function () {
                this.populateCurrentSchedule("Schema 1"); //pick first for now
            },
            populateCurrentSchedule: function(scheduleName) {
                var scheduleData = this.schedules.filter(function (schedule) {
                    return schedule.name === scheduleName;
                })[0];

                if (scheduleData === null) return;

                this.currentSchedule.shiftDefinitions = scheduleData.shiftDefinitions;
                this.currentSchedule.numberOfWeeks = scheduleData.numberOfWeeks;
                this.currentSchedule.employees = this.employeesFromCodes(scheduleData.employeeCodes);

                this.currentSchedule.name = scheduleData.name;
                this.currentSchedule.weekSchedules = [];
                for (var i = 0; i < scheduleData.numberOfWeeks; i++) {
                    this.currentSchedule.weekSchedules.push({shifts: []});
                }

                scheduleData.shifts.forEach(function (shiftData) {
                    var shiftDefinition = scheduleData.shiftDefinitions.filter(function (shiftDefinition) {
                        return shiftDefinition.code === shiftData.shiftCode;
                    })[0];
                    for (var i = 0; i < shiftData.weeks.length; i++) {
                        var shift = {
                            code: shiftData.shiftCode,
                            employee: this.employees.filter(function (employee) {
                                return employee.code === shiftData.employeeCode;
                            })[0],
                            employees: this.employeesFromCodes(shiftData.employeeCodes),
                            workplace: this.workplaces.filter(function (workplace) {
                                return workplace.code === shiftData.workplaceCode;
                            })[0],
                            week: shiftData.weeks[i],
                            startTime: shiftDefinition ? shiftDefinition.startTime : 0,
                            endTime: shiftDefinition ? shiftDefinition.endTime : 0,
                            dayOfWeek: shiftData.dayOfWeek,
                            numberOfShiftsWideForFirst: 1,
                            numberOfShiftsWideForSecond: 1,
                            positionForFirst: 1,
                            positionForSecond: 1
                        };

                        //pxWidth: 60 //automatically calculated for now, might be needed?

                        //numberOfShiftsWide: 2,

                        this.currentSchedule.weekSchedules[shift.week - 1].shifts.push(shift);
                        if (shift.endTime < shift.startTime) {
                            if (shift.dayOfWeek === 7) {
                                if (shift.week !== this.currentSchedule.numberOfWeeks) {
                                    this.currentSchedule.weekSchedules[shift.week].shifts.push(shift);
                                } else {
                                    this.currentSchedule.weekSchedules[0].shifts.push(shift);
                                }
                            }
                        }

                    }
                }, this);
                this.adjustShiftWidths();
            },
            adjustShiftWidths: function () {
                var getAdjustedStartTime = function (shift, dayOfWeek) {
                    var startTime;

                    if (shift.startTime < shift.endTime) {
                        //shift within same day
                        startTime = shift.startTime;
                    } else {
                        //shift spans over two days
                        if (shift.dayOfWeek === dayOfWeek) {
                            //use first part of shift (i.e. [22:00]-00:00)
                            startTime = shift.startTime;
                        } else {
                            //use second part of shift (i.e. [00:00]-06:00)
                            startTime = 0;
                        }
                    }

                    return startTime;
                };

                var getAdjustedEndTime = function (shift, dayOfWeek) {
                    var endTime;

                    if (shift.startTime < shift.endTime) {
                        //shift within same day
                        endTime = shift.endTime;
                    } else {
                        //shift spans over two days
                        if (shift.dayOfWeek === dayOfWeek) {
                            //use first time of shift (i.e. 22:00-[00:00])
                            endTime = NUMBER_OF_MINUTES_IN_A_DAY;
                        } else {
                            //use second time of shift (i.e. 00:00-[06:00])
                            endTime = shift.endTime;
                        }
                    }

                    return endTime;
                };

                var isFirstOrSecondEvaluated = function (shift, dayOfWeek) {
                    var result;

                    if (shift.startTime < shift.endTime) {
                        result = "first";
                    } else {
                        if (shift.dayOfWeek === dayOfWeek) {
                            result = "first";
                        } else {
                            result = "second";
                        }
                    }

                    return result;
                };

                for (var currentWeekIndex = 0; currentWeekIndex < this.currentSchedule.weekSchedules.length; currentWeekIndex++) {
                    for (var dayOfWeek = 1; dayOfWeek <= 7; dayOfWeek++) {
                        var currentShifts = this.currentSchedule.weekSchedules[currentWeekIndex].shifts.filter( function(shift) {
                            return ((shift.week === currentWeekIndex + 1 && shift.dayOfWeek === dayOfWeek && isFirstOrSecondEvaluated(shift, dayOfWeek) === "first") ||
                            (shift.week === currentWeekIndex + 1 && shift.dayOfWeek === dayOfWeek - 1 && isFirstOrSecondEvaluated(shift, dayOfWeek) === "second") ||
                            (shift.week !== currentWeekIndex + 1 && shift.dayOfWeek === 7 && dayOfWeek === 1 && isFirstOrSecondEvaluated(shift, dayOfWeek) === "second"));
                        });

                        currentShifts = currentShifts.sort(function(a,b) {
                            // if shift spans over two days, and shift's dayOfWeek is not equal to current day's dayOfWeek, set startTime to 0.
                            // if shift spans over two days, and shift's dayOfWeek is equal to current day's dayOfWeek, set endTime to 1440.
                            // sort on 1) startTime, ascending, 2) endTime, ascending
                            var result = 0;
                            var aStartTime = getAdjustedStartTime(a, dayOfWeek);
                            var aEndTime = getAdjustedEndTime(a, dayOfWeek);
                            var bStartTime = getAdjustedStartTime(b, dayOfWeek);
                            var bEndTime = getAdjustedEndTime(b, dayOfWeek);
                            if (aStartTime !== bStartTime) {
                                result = aStartTime - bStartTime;
                            } else {
                                result = aEndTime - bEndTime;
                            }
                            return result;
                        });

                        var setShiftPosition = function(shift, position) {
                            if (isFirstOrSecondEvaluated(shift, dayOfWeek) === "first") {
                                shift.positionForFirst = position;
                            } else {
                                shift.positionForSecond = position;
                            }
                        };
                        var getShiftPosition = function(shift) {
                            if (isFirstOrSecondEvaluated(shift, dayOfWeek) === "first") {
                                return shift.positionForFirst;
                            } else {
                                return shift.positionForSecond;
                            }
                        };
                        var setShiftWidth = function(shift, width, addToPrevious) {
                            if (isFirstOrSecondEvaluated(shift, dayOfWeek) === "first") {
                                if (addToPrevious) {
                                    shift.numberOfShiftsWideForFirst = shift.numberOfShiftsWideForFirst + width;
                                } else {
                                    shift.numberOfShiftsWideForFirst = width;
                                }
                            } else {
                                if (addToPrevious) {
                                    shift.numberOfShiftsWideForSecond = shift.numberOfShiftsWideForSecond + width;
                                } else {
                                    shift.numberOfShiftsWideForSecond = width;
                                }
                            }
                        };
                        var getShiftWidth = function(shift) {
                            if (isFirstOrSecondEvaluated(shift, dayOfWeek) === "first") {
                                return shift.numberOfShiftsWideForFirst;
                            } else {
                                return shift.numberOfShiftsWideForSecond;
                            }
                        };

                        var currentShiftIndex;
                        for (currentShiftIndex = 0; currentShiftIndex < currentShifts.length; currentShiftIndex++) {
                            var currentShift = currentShifts[currentShiftIndex];
                            var currentStartTime = getAdjustedStartTime(currentShift, dayOfWeek);
                            var currentEndTime = getAdjustedEndTime(currentShift, dayOfWeek);
                            if (currentShift.dayOfWeek === 1) {
                                var haltHere;
                            }

                            var timeCollidingShifts = currentShifts.filter( function(shift) {
                                if (shift === currentShift) return true;
                                var otherStartTime = getAdjustedStartTime(shift, dayOfWeek);
                                var otherEndTime = getAdjustedEndTime(shift, dayOfWeek);
                                var isColliding =  ((otherStartTime <= currentStartTime && otherEndTime > currentStartTime) || (otherStartTime > currentStartTime && otherStartTime < currentEndTime));
                                var isLeftColliding = (isColliding && currentShifts.indexOf(currentShift) > currentShifts.indexOf(shift));
                                return isLeftColliding;
                            });

                            setShiftWidth(currentShift, timeCollidingShifts.length, false);
                            timeCollidingShifts.forEach( function (shift) {
                                if (getShiftWidth(shift) < timeCollidingShifts.length) {
                                    setShiftWidth(shift, 1, true);
                                }
                            });

                            var spaceFound = false;
                            var shiftPosition;
                            var currentShiftWidth = getShiftWidth(currentShift);
                            var shiftWidth = currentShiftWidth;
                            var currentShiftPosition = getShiftPosition(currentShift);
                            while (!spaceFound && shiftWidth < 10) { //10 to prevent an infinite loop if a bug is encountered
                                for (shiftPosition = 1; shiftPosition <= shiftWidth; shiftPosition++) {
                                    var spaceCollidingShifts = timeCollidingShifts.filter( function (shift) {
                                        if (shift === currentShift) return false;
                                        var otherShiftPosition = getShiftPosition(shift);
                                        var isColliding = (otherShiftPosition === shiftPosition && currentShifts.indexOf(currentShift) > currentShifts.indexOf(shift));
                                        if (isColliding) {
                                            return true;
                                        } else {
                                            return false;
                                        }
                                    });
                                    if (spaceCollidingShifts.length === 0) {
                                        spaceFound = true;
                                        currentShiftPosition = shiftPosition;
                                        break;
                                    }
                                }
                                if (shiftWidth === currentShiftPosition && !spaceFound) {
                                    shiftWidth = shiftPosition + 1;
                                }
                            }
                            if (currentShiftPosition > shiftWidth) {
                                shiftWidth = currentShiftPosition;
                            }
                            setShiftWidth(currentShift, shiftWidth, false);
                            setShiftPosition(currentShift, currentShiftPosition);
                        }
                    }
                }
            },
            dragInfo: {},
            dragInfoChanged: function(oldValue, newValue) {
                if (Object.keys(this.dragInfo).length === 0) { //check if this.dragInfo is an empty object (no object is dragged -> cursor should be visible)
                    this.style.cursor = "default";
                    this.$.paperSlider.style.cursor = "default";
                } else {
                    this.style.cursor = "none";
                    this.$.paperSlider.style.cursor = "none";
                }

                if (newValue && newValue.event && newValue.event.type === "track") {
                    if (newValue.draggedItem.id === "oneShift") {
                        this.disablePointerEventsForOneShifts();
                    }
                }
                if (oldValue && oldValue.event && oldValue.event.type === "trackend") {
                    //if an employee is dropped...
                    if (oldValue.draggedItem.id === "oneEmployee") {
                        this.moveEmployee(oldValue);
                    } else if (oldValue.draggedItem.id === "oneShift") {
                        this.enablePointerEventsForOneShifts();
                        this.moveShift(oldValue);
                    }
                }
            },
            moveEmployee: function(dragInfo) {
                //if the target is a "oneShift"...
                if (dragInfo.dropTarget && dragInfo.dropTarget.id === "oneShift") {
                    //if this "oneShift" does not already have the "employee"
                    if (dragInfo.dropTarget.shift.employees.indexOf(dragInfo.draggedItem.employee) === -1) {
                        //add the "employee" to the "oneShift")
                        dragInfo.dropTarget.shift.employees.push(dragInfo.draggedItem.employee);
                        //if the "employee" was dragged from (another) "oneShift"

                        if (dragInfo.draggedItem.offsetParent.id === "oneShift") {
                            //remove the "employee" from that "oneShift"
                            dragInfo.draggedItem.offsetParent.shift.employees.splice(dragInfo.draggedItem.offsetParent.shift.employees.indexOf(dragInfo.draggedItem.employee), 1);
                        }
                    }
                }
            },
            moveShift: function(dragInfo) {
                //if the target is a "oneShift"...
                if (dragInfo.dropTarget && dragInfo.dropTarget.id === "weekDay") {

                    var dropWeekDayIndex = parseInt(dragInfo.dropTarget.attributes['weekDayIndex'].value);

                    var dropOneWeek = dragInfo.dropTarget.parentElement.offsetParent;
                    var dropShifts = dropOneWeek.data.shifts;
                    var draggedShift =  dragInfo.draggedItem.shift;
                    //if this week does not already have the "oneShift" or if this week, but not this "weekDay" have the "oneShift"
                    if (dropShifts.indexOf(draggedShift) === -1 || (dropShifts.indexOf(draggedShift) !== -1 && draggedShift.dayOfWeek !== dropWeekDayIndex + 1)) {
                        draggedShift.week = dropOneWeek.weekNumber;
                        draggedShift.dayOfWeek = dropWeekDayIndex + 1;

                        var originOneWeek = dragInfo.draggedItem.parentElement.offsetParent;

                        //sometimes one shift spans over several weeks, fetch all weeks that holds the dragged shift.
                        var weekSchedulesWithShift = this.currentSchedule.weekSchedules.filter( function (weekSchedule) {
                            return weekSchedule.shifts.indexOf(draggedShift) !== -1;
                        });
                        //...remove this shift from this/these weeks.
                        weekSchedulesWithShift.forEach( function(weekSchedule) {
                            weekSchedule.shifts.splice(weekSchedule.shifts.indexOf(draggedShift), 1);
                        });
                        //add the shift to the week it is dragged to. Make a copy to trigger a UI update.
                        var dropWeekSchedule = this.currentSchedule.weekSchedules[dropOneWeek.weekNumber - 1];
                        dropWeekSchedule.shifts.push(JSON.parse(JSON.stringify(draggedShift)));

                        //if the shift is dragged to a Sunday and the shift spans over two days, also add it to next week's shifts.
                        if (draggedShift.dayOfWeek === 7 && draggedShift.endTime <= draggedShift.startTime) {
                            var nextDropWeekSchedule;
                            //if next week is within the number of weeks, set next week to the dragged-to week + 1
                            if (dropOneWeek.weekNumber < this.currentSchedule.numberOfWeeks) {
                                nextDropWeekSchedule = this.currentSchedule.weekSchedules[dropOneWeek.weekNumber - 1 + 1];
                            //...or else, there are no more weeks, set next week to the first week
                            } else {
                                nextDropWeekSchedule = this.currentSchedule.weekSchedules[0];
                            }
                            //add a copy to the next week. Make a copy to trigger a UI update.
                            nextDropWeekSchedule.shifts.push(JSON.parse(JSON.stringify(draggedShift)));
                        }


                        //originOneWeek.data.shifts.splice(originOneWeek.data.shifts.indexOf(draggedShift), 1);
                        //add dragged "oneShift" to the new "weekDay" of the new "oneWeek". Copy the shift to trigger an UI update.
                        //dropShifts.push(JSON.parse(JSON.stringify(draggedShift))); //trigger update

                        //todo: also remove the "oneShift" from adjacent week, if the shift spans over two weeks (sunday-monday).
                        //todo: also add the "oneShift" to adjacent week, if the shift spans over two weeks (sunday-monday)
                        if (draggedShift.dayOfWeek === 7 && draggedShift.endTime <= draggedShift.startTime) {
                            //console.log("dragged from week: " + draggedShift.dayOfWeek)
                        }
                    }
                    this.adjustShiftWidths(); //recalculate the shifts' widths.
                }
            },
            disablePointerEventsForOneShifts: function() {
                var els = document.querySelectorAll('* /deep/ #oneShift');
                for (var i = 0; i < els.length; i++) {
                    els[i].style.pointerEvents = "none";
                }
            },
            enablePointerEventsForOneShifts: function() {
                var els = document.querySelectorAll('* /deep/ #oneShift');
                for (var i = 0; i < els.length; i++) {
                    els[i].style.pointerEvents = "auto";
                }
            }
        });
    </script>
</polymer-element>